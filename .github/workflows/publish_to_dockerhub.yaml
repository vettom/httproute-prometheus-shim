name: Build and Push Docker Image

on:
  push:
    branches:
      - main
 
permissions:
  id-token: write   # This is required for requesting the JWT
  contents: write    # This is required for actions/checkout

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # to get tags

      - name: Set Repo Name
        run: echo "IMAGE_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV

      - name: Get latest tag
        id: get_latest_tag
        run: |
          latest_tag=$(git tag --sort=-version:refname | head -1)
          if [ -z "$latest_tag" ]; then
            latest_tag="v0.0.0"
          fi
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
          echo "latest_tag=$latest_tag" 

      - name: Increment version
        id: increment_version
        run: |
          latest_tag="${{ steps.get_latest_tag.outputs.latest_tag }}"
          # Remove v prefix
          version="${latest_tag#v}"
          # Split into major.minor.patch
          IFS='.' read -r major minor patch <<< "$version"
          # Increment patch
          new_patch=$((patch + 1))
          new_version="$major.$minor.$new_patch"
          new_tag="v$new_version"
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT

      - name: Show image name and tag
        run: echo "Image Name is ${{ secrets.DOCKERHUB_USER }}/${{ env.IMAGE_NAME }}:${{ steps.increment_version.outputs.new_tag }}"
 
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ secrets.DOCKERHUB_USER }}/${{ env.IMAGE_NAME }}:${{ steps.increment_version.outputs.new_tag }}

      - name: Create tag
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'refs/tags/${{ steps.increment_version.outputs.new_tag }}',
              sha: context.sha
            })

      - name: Update Helm chart version
        run: |
          APP_VERSION="${{ steps.increment_version.outputs.new_tag }}"
          CHART_VERSION="${{ steps.increment_version.outputs.new_version }}"

          echo "APP_VERSION=${APP_VERSION}, CHART_VERSION=${CHART_VERSION}"
          sed -i "s/^version: .*/version: $CHART_VERSION/" ./helm/${{ env.IMAGE_NAME }}/Chart.yaml
          sed -i "s/^appVersion: .*/appVersion: ${APP_VERSION}/" ./helm/${{ env.IMAGE_NAME }}/Chart.yaml

          sed -i "s/tag:.*/tag: \"${APP_VERSION}\"/" ./helm/${{ env.IMAGE_NAME }}/values.yaml
          cat ./helm/${{ env.IMAGE_NAME }}/Chart.yaml
